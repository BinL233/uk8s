# cloudprovider更新20.10.1

## 变更记录

### 更新版本：20.10.1

更新时间：2020年10月20日

更新内容：

* 动态创建成功LoadBalancer类型的Service后，插件将把关联的ULB Id注入到Service的Annotations中，以规避因API超时等导致的ULB重建。


### 更新版本：20.09.4

更新时间：2020年9月18日

变更内容：

* 升级UCloud Go SDK修复ULB防火墙设置，
* 增加新创建时，使用临时的ULB客户端进行API调用。


### 更新版本：20.09.3

更新时间：2020年9月17日

变更内容：

* 更新监控信息(非强制更新)。


### 更新版本：20.09.2

更新时间：2020年9月8日

变更内容：

* 增加cloudprovider重启后调用ULB相关接口的容错性，提高集群的运行的稳定性。

## 更新前置检查

1. 集群创建于2020年10月20日前，且检查cloudprovider版本低于20.10.1
2. 请处于业务闲时进行更新
3. 确定您的UK8S版本，选择对应的更新操作

### 版本查看方法

请在web kubectl页面输入以下命令，可以查看当前集群使用的cloudprovider版本

```
kubectl describe deployment cloudprovider-ucloud -n kube-system |grep Image
```

### UK8S集群版本大于等于1.14

1. 请执行部署更新cloudprovider。

```
kubectl apply -f https://gitee.com/uk8s/uk8s/raw/master/yaml/cloudprovider/20-10-1.yaml
```

2. 检查是否部署成功，如Pod处于非running状态，请您及时与我们技术支持联系。

```
kubectl get pod -n kube-system -l app=cloudprovider-ucloud -o wide
```

### UK8S集群版本小于1.14

> 如您的集群master节点，执行`systemctl status ucloudcp`是运行状态的话，请务必在`3`个节点关闭二进制程序ucloudcp并更新。

1. 请分别登陆3台master节点，执行以下

```
systemctl stop ucloudcp
systemctl disable ucloudcp
```

2. 需要配置前置ConfigMap，请填写如下相关信息并保存文件为`userdata.yaml`。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: uk8sconfig
  namespace: kube-system
data:
  UCLOUD_ACCESS_PRIKEY: xxxxxxxxxxxxxxx  #API PRIKEY
  UCLOUD_ACCESS_PUBKEY: xxxxxxxxxxxxxxx  #API_PUBKEY
  UCLOUD_API_ENDPOINT: http://api.service.ucloud.cn
  UCLOUD_PROJECT_ID: org-xxxxxx   #集群所在的项目ID
  UCLOUD_REGION_ID: cn-bj2  #集群所在的地域
  UCLOUD_SUBNET_ID: subnet-xxxxxx  #集群所在的子网ID
  UCLOUD_UK8S_CLUSTER_ID: uk8s-xxxxxx  #UK8S集群名称
  UCLOUD_VPC_ID: uvnet-xxxxxx   #集群所在的VPC ID
  UCLOUD_ZONE_ID: 'cn-bj2-03'   #集群所在的可用区
```

3. 请执行创建ConfigMap。

```
kubectl apply -f userdata.yaml
```

4. 请执行部署cloudprovider。

```
kubectl apply -f https://gitee.com/uk8s/uk8s/raw/master/yaml/cloudprovider/20-10-1.yaml
```

5. 检查是否部署成功，如Pod处于非running状态，请您及时与我们技术支持联系。

```
kubectl get pod -n kube-system -l app=cloudprovider-ucloud -o wide
```