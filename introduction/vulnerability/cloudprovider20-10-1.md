# cloudprovider 更新 20.10.1

## 变更记录

### 更新版本：20.10.1

更新时间：2020 年 10 月 20 日

更新内容：

- 动态创建成功 LoadBalancer 类型的 Service 后，插件将把关联的 ULB Id 注入到 Service 的 Annotations 中，以规避因 API 超时等导致的 ULB 重建。

### 更新版本：20.09.4

更新时间：2020 年 9 月 18 日

变更内容：

- 升级 UCloud Go SDK 修复 ULB 防火墙设置，
- 增加新创建时，使用临时的 ULB 客户端进行 API 调用。

### 更新版本：20.09.3

更新时间：2020 年 9 月 17 日

变更内容：

- 更新监控信息（非强制更新）。

### 更新版本：20.09.2

更新时间：2020 年 9 月 8 日

变更内容：

- 增加 cloudprovider 重启后调用 ULB 相关接口的容错性，提高集群的运行的稳定性。

## 更新前置检查

1. 集群创建于 2020 年 10 月 20 前，且检查 cloudprovider 版本低于 20.10.1
2. 请处于业务闲时进行更新
3. 确定您的 UK8S 版本，选择对应的更新操作

### UK8S 集群版本大于等于 1.14

1. 请执行部署更新 cloudprovider。

```
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/cloudprovider/20.10.1.yml
```

2. 检查是否部署成功，如 Pod 处于非 running 状态，请您及时与我们技术支持联系。

```
kubectl get pod -n kube-system -l app=cloudprovider-ucloud -o wide
```

### UK8S 集群版本小于 1.14

1. 请分别登陆 3 台 master 节点，执行以下

```
systemctl stop ucloudcp
systemctl disable ucloudcp
```

2. 需要配置前置 ConfigMap，请填写如下相关信息并保存文件为`userdata.yaml`。

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: uk8sconfig
  namespace: kube-system
data:
  UCLOUD_ACCESS_PRIKEY: xxxxxxxxxxxxxxx  #API PRIKEY
  UCLOUD_ACCESS_PUBKEY: xxxxxxxxxxxxxxx  #API_PUBKEY
  UCLOUD_API_ENDPOINT: http://api.service.ucloud.cn
  UCLOUD_PROJECT_ID: org-xxxxxx   #集群所在的项目 ID
  UCLOUD_REGION_ID: cn-bj2  #集群所在的地域
  UCLOUD_SUBNET_ID: subnet-xxxxxx  #集群所在的子网 ID
  UCLOUD_UK8S_CLUSTER_ID: uk8s-xxxxxx  #UK8S 集群名称
  UCLOUD_VPC_ID: uvnet-xxxxxx   #集群所在的 VPC ID
  UCLOUD_ZONE_ID: 'cn-bj2-03'   #集群所在的可用区
```

3. 请执行创建 ConfigMap。

```
kubectl apply -f userdata.yaml
```

4. 请执行部署 cloudprovider。

```
kubectl apply -f https://docs.ucloud.cn/uk8s/yaml/cloudprovider/20-10-1.yml
```

5. 检查是否部署成功，如 Pod 处于非 running 状态，请您及时与我们技术支持联系。

```
kubectl get pod -n kube-system -l app=cloudprovider-ucloud -o wide
```
